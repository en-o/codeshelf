# CodeShelf 在线更新配置指南

## 概述

CodeShelf 使用 Tauri 的 updater 插件 + GitHub Releases 实现在线更新。

**工作流程：**

```
修改代码 → 更新版本号 → 创建 release 分支并推送 → GitHub Actions 自动构建 → 生成 Release → 用户检查更新 → 下载安装
```

> **注意：** 构建只会在 `release/*` 或 `release/**` 分支上触发，不会在 main 分支触发。

---

## 一、生成签名密钥（仅需一次）

Tauri updater 要求对更新包签名，防止被篡改。

### 1. 生成密钥对

```bash
npm run tauri signer generate -- -w ~/.tauri/codeshelf.key
```

执行后会输出：

```
Please enter a password to protect the secret key:    # 输入密码（可留空直接回车）
Password:
Deriving a key from the password and target...

Your keypair was generated successfully
Private: /Users/you/.tauri/codeshelf.key
Public:  dW50cnVzdGVkIGNvbW1lbnQ6IG1pbmlzaWduIHB1Y...   ← 复制这个公钥
```

### 2. 将公钥写入配置

打开 `src-tauri/tauri.conf.json`，将公钥替换 `YOUR_PUBLIC_KEY_HERE`：

```json
"plugins": {
  "updater": {
    "pubkey": "这里粘贴上一步输出的公钥字符串",
    "endpoints": [
      "https://github.com/en-o/codeshelf/releases/latest/download/latest.json"
    ]
  }
}
```

### 3. 保存私钥

妥善保管 `~/.tauri/codeshelf.key` 文件，后续配置 GitHub Secrets 需要用到。

---

## 二、配置 GitHub Secrets

进入 GitHub 仓库页面：**Settings → Secrets and variables → Actions → New repository secret**

添加以下两个 Secret：

| Secret 名称 | 值 |
|---|---|
| `TAURI_SIGNING_PRIVATE_KEY` | `~/.tauri/codeshelf.key` 文件的全部内容 |
| `TAURI_SIGNING_PRIVATE_KEY_PASSWORD` | 生成密钥时输入的密码（如果留空则填空字符串） |

---

## 三、发布新版本

### 1. 修改版本号

发布前需要同步修改 **三个文件** 的版本号：

| 文件 | 字段 | 示例 |
|---|---|---|
| `src-tauri/tauri.conf.json` | `"version"` | `"0.2.0"` |
| `package.json` | `"version"` | `"0.2.0"` |
| `src-tauri/Cargo.toml` | `version` | `"0.2.0"` |

> **注意：** 三个文件的版本号必须保持一致。

### 2. 创建 release 分支并推送

```bash
# 在 main 分支上更新版本号
git add -A
git commit -m "chore: bump version to 0.2.0"

# 创建 release 分支（分支名格式：release/版本号）
git checkout -b release/0.2.0

# 推送 release 分支，触发 GitHub Actions 构建
git push origin release/0.2.0
```

### 3. 等待 GitHub Actions 构建

推送 release 分支后，GitHub Actions 会自动：

1. 在 Windows、macOS（x86 + ARM）、Linux 三个平台并行构建
2. 生成安装包和签名文件
3. 创建 **Draft Release**（草稿状态）
4. 上传所有构建产物，包含关键的 `latest.json`

### 4. 发布 Release

1. 进入 GitHub 仓库 → **Releases** 页面
2. 找到刚创建的 Draft Release
3. 编辑更新日志（Release Notes）
4. 点击 **Publish release**

### 5. 合并回 main 分支（可选）

发布完成后，将 release 分支合并回 main：

```bash
git checkout main
git merge release/0.2.0
git push origin main

# 可选：删除 release 分支
git branch -d release/0.2.0
git push origin --delete release/0.2.0
```

发布后，`latest.json` 的访问地址为：

```
https://github.com/en-o/codeshelf/releases/latest/download/latest.json
```

---

## 四、用户端更新

用户打开 CodeShelf → **设置 → 应用更新 → 检查更新**

如果有新版本，界面会显示版本号和更新日志，点击「下载并安装更新」即可自动完成：

1. 下载更新包（显示进度条）
2. 验证签名
3. 安装更新
4. 自动重启应用

---

## 五、文件结构说明

```
codeshelf/
├── .github/workflows/
│   └── release.yml                # GitHub Actions 构建发布工作流
├── src-tauri/
│   ├── tauri.conf.json            # updater 配置（pubkey、endpoints）
│   ├── Cargo.toml                 # tauri-plugin-updater 依赖
│   └── src/lib.rs                 # 注册 updater 插件
├── src/
│   ├── services/updater/index.ts  # 更新检查与下载逻辑
│   └── pages/Settings/
│       └── UpdateSettings.tsx     # 更新设置界面
└── package.json                   # @tauri-apps/plugin-updater 依赖
```

---

## 六、分支策略

```
main (主分支，日常开发)
  │
  ├── release/0.1.0  →  触发构建  →  发布 v0.1.0
  │
  ├── release/0.2.0  →  触发构建  →  发布 v0.2.0
  │
  └── release/1.0.0  →  触发构建  →  发布 v1.0.0
```

- **main 分支**：日常开发，推送不会触发构建
- **release/* 分支**：版本发布分支，推送会自动触发 GitHub Actions 构建

---

## 七、常见问题

### Q: 构建失败提示缺少 TAURI_SIGNING_PRIVATE_KEY？

确认已在 GitHub 仓库的 **Settings → Secrets → Actions** 中正确添加了 `TAURI_SIGNING_PRIVATE_KEY` 和 `TAURI_SIGNING_PRIVATE_KEY_PASSWORD`。

### Q: 用户检查更新提示网络错误？

- 确认 Release 已从 Draft 状态改为 Published
- 确认 Release 的 Assets 中包含 `latest.json` 文件
- 国内网络可能无法直接访问 GitHub，可考虑使用代理或更换 endpoint 为镜像地址

### Q: 更新后版本没变？

三个文件的版本号必须一致且大于当前版本。检查：
- `src-tauri/tauri.conf.json` → `version`
- `package.json` → `version`
- `src-tauri/Cargo.toml` → `version`

### Q: 只想构建 Windows 版本？

修改 `.github/workflows/release.yml`，删除 `matrix` 中不需要的平台配置，只保留：

```yaml
matrix:
  include:
    - platform: 'windows-latest'
      args: ''
```

### Q: 如何手动触发构建？

工作流已配置 `workflow_dispatch`，可在 GitHub 仓库 → **Actions → Release → Run workflow** 手动触发，并输入版本号。

### Q: 推送到 main 分支会触发构建吗？

**不会**。构建只在 `release/*` 或 `release/**` 分支上触发。
